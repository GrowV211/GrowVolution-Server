<form method="post" id="form">
    <div class="m-3">
        <div class="d-flex">
            <a id="profile_image">
                {% include "basic/account/profile_image.html" %}
            </a>
            <div class="d-flex flex-column align-self-center ml-3">
                <span id="img_name" class="mb-1">{{ user.img if user.img else 'Kein Bild vorhanden...' }}</span>
                <div class="d-flex">
                    <button type="button" class="btn btn-primary img-input-btn" onclick="document.getElementById('img_input').click()">Ändern</button>
                    <button id="del" type="button" class="btn btn-danger img-input-btn ml-3">Löschen</button>
                </div>
                <input id="img_input" type="file" class="img-input">
            </div>
            <div class="container" id="nav-container">
                <i id="back" class="bi bi-arrow-left float-end"></i>
            </div>
        </div>
        <div class="d-flex flex-column justify-content-center mt-3">
            <div class="row text-center">
                <div class="col">
                    <input type="text" id="first" class="form-control" value="{{ first }}" disabled>
                </div>
                <div class="col">
                    <input type="text" id="last" class="form-control" value="{{ last }}" disabled>
                </div>
            </div>
            <div class="mt-3">
                <div class="input-group">
                    <span class="input-group-text font-20" id="user-addon">@</span>
                    <input type="text" id="user" name="user" class="form-control" value="{{ username }}" aria-describedby="user-addon user-hint user-warn" required>
                </div>
                <span class="text-danger" id="user-warn" style="display: none">Dieser Benutzername ist schon vergeben.</span>
                <span class="form-text" id="user-hint"></span>
            </div>
            <div class="mt-3">
                <div class="input-group">
                    <span class="input-group-text" id="email-addon"><i class="bi bi-envelope font-16"></i></span>
                    <input type="text" id="email" name="email" class="form-control" value="{{ email }}" aria-describedby="email-addon email-warn email-hint" required>
                </div>
                <span class="text-danger" id="email-warn" style="display: none">Diese E-Mail Adresse ist bereits in Verwendung.</span>
                <span class="form-text" id="email-hint" style="display: none">
                    Vorübergehende Änderung, bitte bestätige deine E-Mail Adresse.
                    Falls du keine E-Mail erhalten hast, kannst du <span id='lock-time'></span>
                    <a id='resend' class="text-primary">hier</a> eine neue anfordern.
                </span>
            </div>
            <textarea id="info" name="info" class="form-control mt-3" placeholder="Erzähl etwas über dich..." rows="4">{{ info if info else ''}}</textarea>
            <div class="container mt-3">
                <button type="submit" id="send" class="btn btn-success float-end ml-3">Speichern</button>
                <button type="button" id="reset" class="btn btn-secondary float-end">Zurücksetzen</button>
            </div>
        </div>
    </div>
</form>

<div class="modal fade" id="edit_modal" tabindex="-1" aria-labelledby="imageEditModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageEditModalLabel">Profilbild bearbeiten</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
          <img id="preview">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
        <button id="upload" type="button" class="btn btn-primary">Speichern</button>
      </div>
    </div>
  </div>
</div>

<script>
    const img_input = document.getElementById("img_input")
    const img_preview = document.getElementById("preview")
    const edit_modal = new bootstrap.Modal(document.getElementById('edit_modal'), {});
    let cropper
    const img_name = document.getElementById("img_name")
    const profile_img = document.getElementById("profile_image")

    const user = document.getElementById("user")
    const email = document.getElementById("email")
    const info = document.getElementById("info")

    const user_hint = document.getElementById("user-hint")
    const user_warn = document.getElementById("user-warn")
    const email_hint = document.getElementById("email-hint")
    const email_warn = document.getElementById("email-warn")

    const changeable = {{ changeable }}

    function username_edit_lock(lock = '{{ lock_days }}') {
        user_hint.textContent = `Du kannst deinen Benutzernamen in ${lock} Tagen wieder ändern.`
        user.disabled = true
    }

    if (changeable) {
        username_edit_lock()
    }

    const email_change = {{ email_change }}

    function onEmailChange(lock_time = null, process = null) {
        const timer = document.getElementById("lock-time")
        const resend = document.getElementById("resend")
        let time = {{ lock }}
        let pid = '{{ pid }}'

        if (lock_time)
            time = lock_time

        if (process)
            pid = process

        let locked = time > 0

        email.disabled = true
        email_hint.style.display = "block"

        function update() {
            if (time <= 0) {
                timer.textContent = ''
                return
            }
            timer.textContent = `in ${time.toString()} Sekunden`
        }

        update()

        function locktimer() {
            time--
            update()
            if (time <= 0) {
                locked = false
                clearInterval(interval)
            }
        }

        let interval = setInterval(locktimer, 1000)

        resend.addEventListener("click", () => {
            if (locked)
                return

            fetch(`/resend/${pid}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: 'resend'})
            }).then(res => res.json()).then(data => {
                time = data['lock_time']
                interval = setInterval(locktimer, 1000)
            })
        })
    }

    if (email_change)
        onEmailChange()

    function availability_check(value, type, display) {
        fetch('/availability-check', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({value: value, type: type})
        }).then(res => res.json()).then(data => {
            if (data['available'])
                display.style.display = 'block';
            else
                display.style.display = 'none';
        });
    }

    user.addEventListener("input", (e) => {
        const value = e.target.value

        if (value === '{{ username }}')
            return

        availability_check(value, 'username', user_warn)
    })

    email.addEventListener("input", (e) => {
        const value = e.target.value

        if (!value.includes('@')) {
            email_warn.style.display = 'none';
            return
        }

        availability_check(value, 'email', email_warn)
    })

    img_input.addEventListener("change", function (event) {
       const file = event.target.files[0]
       if (file && file.type.startsWith("image/")) {
           const reader = new FileReader()
           reader.onload = function (e) {
               img_preview.src = e.target.result

               edit_modal.show()

               setTimeout(() => {
                   if (cropper)
                       cropper.destroy()
                   cropper = new Cropper(img_preview, {
                       aspectRatio: 1,
                       viewMode: 1,
                       autoCropArea: 1,
                       background: false,
                       responsive: true,
                       scalable: true
                   })
               }, 200)
           }
           reader.readAsDataURL(file)
       } else
           img_name.textContent = "Ungültiges Dateiformat!"
    })

    function uploadImage() {
        cropper.getCroppedCanvas().toBlob((blob) => {
            const data = new FormData()
            data.append("img", blob, "{{ username }}.jpg")
            fetch("/edit", {
                method: "POST",
                body: data
            }).then(res => res.text()).then(data => {
                edit_modal.hide()
                img_name.textContent = "{{ username }}.jpg"
                profile_img.innerHTML = data
            })
        })
    }
    document.getElementById("upload").addEventListener("click", uploadImage)

    function del() {
        if (!profile_img.querySelector("img"))
            return

        img_name.textContent = "Wird gelöscht..."
        fetch("/edit", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({value: 'delete'})
        }).then(res => res.text()).then(data => {
            img_name.textContent = "Kein Bild vorhanden..."
            profile_img.innerHTML = data
        })
    }
    document.getElementById("del").addEventListener("click", del)

    function reset() {
        fetch("/edit", {
            method: "POST",
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({value: 'reset'})
        }).then(res => res.json()).then(data => {
            user.value = data['user']
            email.value = data['email']
            info.value = data['info']
        })
    }
    document.getElementById("reset").addEventListener("click", reset)

    document.getElementById("form").addEventListener("submit", (event) => {
        event.preventDefault()

        const formData = new FormData(event.target)

        fetch("/edit", {
            method: "POST",
            body: formData
        }).then(res =>  res.json()).then(data => {
            if (data['user_hint']) {
                username_edit_lock(data['lock_user'])
                img_name.textContent = data['img']
            }

            if (data['email_hint']) {
                email_hint.style.display = "block"
                onEmailChange(data['lock_email'], data['pid'])
            }
        })
    })

    document.getElementById("back").addEventListener("click", () => {
        fetch(window.location, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({value: 'profile'})
        }).then(res => res.text()).then(html => {
            comments.innerHTML = html
            init()
        })
    })
</script>